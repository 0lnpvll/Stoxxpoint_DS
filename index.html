<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STOXXPOINT - Stock Valuation Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:,">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --dark-bg: #121828;
            --darker-bg: #151C2E;
            --accent-bg: #2E3D66;
            --orange: #F4AA20;
            --light-blue: #4FC3F7;
            --light-gray: #A0AEC0;
            --white: #FFFFFF;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--white);
            min-height: 100vh;
            background-image: 
                linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 30%, var(--accent-bg) 70%, var(--dark-bg) 100%);
            background-size: 300% 300%;
            animation: gradientBG 25s ease infinite;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .data-status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 80%;
        }

        .data-loading {
            background-color: rgba(244, 170, 32, 0.9);
            color: #121828;
        }

        .data-error {
            background-color: rgba(255, 50, 50, 0.9);
            color: white;
            animation: pulse 2s infinite;
        }

        .data-success {
            background-color: rgba(50, 200, 50, 0.9);
            color: white;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 5%;
            background-color: #121828;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(46, 61, 102, 0.5);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-name {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: 2px;
            color: var(--white);
            text-transform: uppercase;
        }

        .brand-tagline {
            font-size: 14px;
            font-weight: 600;
            color: var(--orange);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-left: auto; /* Выравнивание навигации по правому краю */
        }

        .nav-links {
            display: flex;
            gap: 30px;
            justify-content: flex-end; /* Выравнивание ссылок по правому краю */
        }

        .nav-links a {
            color: var(--light-gray);
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
            transition: var(--transition);
            position: relative;
        }

        .nav-links a:hover {
            color: var(--orange);
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--orange);
            transition: var(--transition);
        }

        .nav-links a:hover::after {
            width: 100%;
        }

        .auth-buttons button {
            background: linear-gradient(135deg, var(--orange), #e69500);
            color: var(--dark-bg);
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 170, 32, 0.4);
        }

        /* Main Content */
        .hero-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 70vh;
            padding: 1px 0 80px;
            text-align: center;
            position: relative;
        }

        .content-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .search-container {
            width: 100%;
            max-width: 600px;
            position: relative;
            margin: 30px 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-top: 15px;
            margin-bottom: 5px;
        }

        .search-box {
            width: 100%;
            padding: 18px 25px;
            font-size: 18px;
            border-radius: 50px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(21, 28, 46, 0.7);
            color: var(--white);
            outline: none;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .search-box:focus {
            border-color: var(--orange);
            box-shadow: 0 0 20px rgba(244, 170, 32, 0.3);
        }

        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .last-updated {
            margin-top: 1px;
            color: var(--light-gray);
            font-size: 14px;
            text-align: center;
        }

        .suggestions-container {
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(21, 28, 46, 0.95);
            border-radius: 15px;
            margin-top: 5px;
            z-index: 10;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: none;
            top: 100%;
        }

        .suggestion-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background: rgba(46, 61, 102, 0.5);
        }

        .suggestion-ticker {
            color: var(--light-blue);
            font-weight: 600;
            width: 80px;
        }

        .suggestion-company {
            color: var(--light-gray);
            flex-grow: 1;
            margin: 0 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .suggestion-label {
            font-weight: 600;
            min-width: 120px;
            text-align: right;
        }

        /* Results Section */
        .result-container {
            display: none;
            background: rgba(21, 28, 46, 0.8);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            max-width: 600px;
            width: 100%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(46, 61, 102, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .result-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Gauge container - широкая версия */
        .gauge-container {
            width: 90%;
            max-width: 800px;
            height: 200px;
            margin: 15px auto;
            position: relative;
        }

        .gauge-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .gauge-foreground {
            position: relative;
            z-index: 2;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.8s ease 0.3s, transform 0.8s ease 0.3s;
        }

        .gauge-foreground.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Info panel */
        .info-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            width: 100%;
            max-width: 350px;
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease 0.6s, transform 0.5s ease 0.6s;
        }

        .result-container.visible .info-panel {
            opacity: 1;
            transform: translateY(0);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            border-bottom: none;
            margin-bottom: 5px;
            padding-bottom: 0;
        }

        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
            justify-content: center;
        }

        .info-company {
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            width: 100%;
        }

        .info-ticker {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            width: 100%;
        }

        .info-price {
            font-size: 16px;
            font-weight: 700;
        }

        .info-score {
            font-size: 16px;
            font-weight: 700;
            color: var(--orange);
        }

        .info-label {
            font-size: 16px;
            font-weight: 700;
            padding: 6px 15px;
            border-radius: 20px;
        }

        /* Ticker Tape */
        .ticker-container {
            width: 100%;
            overflow: hidden;
            margin: 10px 0 10px;
            position: fixed;
            bottom: 95px;
            left: 0;
            right: 0;
            z-index: 20;
            height: 40px;
            padding: 10px 0;
        }

        .ticker-tape {
            display: flex;
            animation: tickerAnimation 30s linear infinite;
        }

        .ticker-item {
            white-space: nowrap;
            margin: 0 40px;
            display: flex;
            align-items: center;
        }

        .ticker-ticker {
            font-weight: 700;
            color: var(--light-blue);
            margin-right: 8px;
        }

        .ticker-label {
            color: var(--light-gray);
        }

        @keyframes tickerAnimation {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* Footer */
        footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: fixed;
            bottom: 0;
            padding-top: 5px;
            padding-bottom: 20px;
            left: 0;
            right: 0;
            z-index: 30;
            background-color: #121828;
            border-top: 1px solid rgba(46, 61, 102, 0.5);
        }

        .download-btn {
            background: linear-gradient(135deg, var(--accent-bg), var(--darker-bg));
            color: var(--white);
            border: 1px solid rgba(244, 170, 32, 0.3);
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
            margin-bottom: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .download-btn:hover {
            background: linear-gradient(135deg, var(--orange), #e69500);
            color: var(--dark-bg);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .copyright {
            color: var(--light-gray);
            font-size: 14px;
            margin-top: 1px;
        }

        /* Auth Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--darker-bg), var(--dark-bg));
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(244, 170, 32, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            margin-bottom: 25px;
            text-align: center;
        }

        .modal-title {
            font-size: 24px;
            color: var(--orange);
            margin-bottom: 10px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--light-gray);
        }

        .input-group input {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(18, 24, 40, 0.7);
            color: var(--white);
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
            border: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, var(--orange), #e69500);
            color: var(--dark-bg);
        }

        .cancel-btn {
            background: transparent;
            color: var(--light-gray);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        .error-message {
            background-color: rgba(255, 50, 50, 0.2);
            border: 1px solid rgba(255, 100, 100, 0.5);
            color: #ff6b6b;
            position: absolute;
            top: calc(100% + 10px);
            left: 0;
            width: 100%;
            z-index: 10;
        }

        .success-message {
            background-color: rgba(50, 255, 50, 0.2);
            border: 1px solid rgba(100, 255, 100, 0.5);
            color: #6bff6b;
        }

        .auth-links {
            text-align: center;
            margin-top: 20px;
        }

        .auth-links a {
            color: var(--light-blue);
            text-decoration: none;
            font-size: 14px;
            display: block;
            margin: 8px 0;
        }

        .auth-links a:hover {
            color: var(--orange);
            text-decoration: underline;
        }

        /* Модификации для улучшения пропорций */
        .result-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .score-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Адаптация для мобильных */
        @media (max-width: 600px) {
            .info-panel {
                width: 95%;
                padding: 15px;
            }
            
            .gauge-container {
                max-width: 240px;
            }
            
            .info-company {
                font-size: 16px;
            }
            
            .info-ticker {
                font-size: 20px;
            }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .nav-links {
                display: none;
            }
            
            .brand-name {
                font-size: 26px;
            }
        }

        @media (max-width: 600px) {
            .logo-container {
                gap: 12px;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }
            
            .brand-name {
                font-size: 22px;
            }
            
            .brand-tagline {
                font-size: 12px;
            }
            
            .search-box {
                padding: 15px 20px;
                font-size: 16px;
            }
            
            .result-container {
                padding: 20px;
                max-width: 90%;
            }
            
            .suggestion-item {
                flex-wrap: wrap;
                padding: 8px 15px;
            }
            
            .suggestion-ticker {
                width: 60px;
            }
            
            .suggestion-label {
                min-width: 100%;
                text-align: left;
                margin-top: 5px;
            }
        }

        /* Стили для раздела методологии */
        .methodology-container, .howto-container {
            display: none;
            background: rgba(21, 28, 46, 0.8);
            border-radius: 20px;
            padding: 30px;
            margin: 30px auto;
            max-width: 900px;
            width: 90%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(46, 61, 102, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .methodology-container.visible, .howto-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Кнопка "Back to Search" - восстановлены оригинальные стили */
        .back-to-search {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--light-blue); /* Светло-синий цвет */
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
            z-index: 5;
        }

        .back-to-search:hover {
            color: var(--orange); /* Оранжевый при наведении */
        }

        .methodology-content, .howto-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-top: 30px;
        }

        .methodology-header, .howto-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .methodology-title, .howto-title {
            font-size: 28px;
            color: var(--orange);
            margin-bottom: 10px;
        }

        .methodology-subtitle, .howto-subtitle {
            color: var(--light-gray);
            font-size: 16px;
        }

        .methodology-text, .howto-text {
            color: var(--light-gray);
            line-height: 1.7;
            font-size: 16px;
            text-align: justify;
        }

        .methodology-text h3, .howto-text h3 {
            color: var(--orange);
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .methodology-text p, .howto-text p {
            margin-bottom: 15px;
        }

        .methodology-text ul, .howto-text ul {
            margin-left: 25px;
            margin-bottom: 20px;
        }

        .methodology-text li, .howto-text li {
            margin-bottom: 10px;
        }

        .methodology-highlight {
            color: var(--light-blue);
            font-weight: 600;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .methodology-container, .howto-container {
                padding: 20px;
            }
            
            .methodology-title, .howto-title {
                font-size: 24px;
            }
            
            .methodology-text, .howto-text {
                font-size: 15px;
            }
        }

        /* Убираем подчеркивание у заголовка */
        .hero-section h1 {
            background: linear-gradient(to right, var(--orange), var(--white));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none !important;
            font-size: 36px; 
            margin-bottom: 1px; 
            text-align: center;
        }

        .image-container {
            margin: 20px 0;
            text-align: center;
        }
        
        .content-image {
            max-width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }
        
        .image-caption {
            color: var(--light-gray);
            font-size: 14px;
            font-style: italic;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Сообщение о статусе данных -->
    <div class="data-status" id="dataStatus" style="display: none;"></div>
    
    <!-- Header -->
    <header>
        <div class="logo-container">
<img src="https://hfqtqjjsagwcbhyzzrnp.supabase.co/storage/v1/object/public/uploads/Logo.png" alt="STOXXPOINT Logo" class="logo">
            <div class="brand-text">
                <div class="brand-name">STOXXPOINT</div>
                <div class="brand-tagline">Cheap or Pricey? See Now!</div>
            </div>
        </div>
        
        <div class="nav-right">
            <nav class="nav-links">
                <a href="#" id="methodologyLink">Evaluation Methodology</a>
                <a href="#" id="howtoLink">How to Use</a> <!-- Добавлена новая ссылка -->
                <a href="#">Donate</a>
            </nav>
            
            <div class="auth-buttons">
                <button id="adminLoginBtn">Log In / Sign Up</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <section class="hero-section" id="mainContent">
            <div class="content-container">
                <h1>Stock Valuation Intelligence</h1>
                
                <div class="search-container">
                    <input type="text" class="search-box" id="stockSearch" placeholder="Enter a stock ticker or company name...">
                    <div class="suggestions-container" id="suggestionsContainer"></div>
                    <div class="message error-message" id="errorMessage"></div>
                </div>
                
                <div class="last-updated" id="lastUpdated">
                    Loading data...
                </div>
                
                <!-- Контейнер результатов скрыт по умолчанию -->
                <div class="result-container" id="resultContainer">
                    <button class="back-to-search" id="backToSearch">
                        <i class="fas fa-arrow-left"></i> Back to Search
                    </button>
                    
                    <div class="score-container">
                        <div class="gauge-container">
                            <!-- Два слоя для спидометра -->
                            <canvas class="gauge-background" id="speedometerBackground"></canvas>
                            <canvas class="gauge-foreground" id="speedometer"></canvas>
                        </div>
                        
                        <div class="info-panel">
                            <div class="info-row">
                                <div class="info-company" id="infoCompany">Company Name</div>
                            </div>
                            <div class="info-row">
                                <div class="info-ticker" id="infoTicker">TICKER</div>
                            </div>
                            <div class="info-row">
                                <div>Day Close Price:</div>
                                <div>Score:</div>
                            </div>
                            <div class="info-row">
                                <div class="info-price" id="infoPrice">$0.00</div>
                                <div class="info-score" id="infoScore">5/9</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label" id="infoLabel">FAIR PRICE</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Раздел методологии -->
        <div class="methodology-container" id="methodologyContainer">
            <button class="back-to-search" id="backToSearchFromMethodology">
                <i class="fas fa-arrow-left"></i> Back to Search
            </button>
            
            <div class="methodology-content">
                <div class="methodology-header">
                    <h2 class="methodology-title">STOXXPOINT Valuation Methodology</h2>
                    <p class="methodology-subtitle">Our comprehensive approach to stock valuation</p>
                </div>
                
<div class="image-container">
    <img src="https://hfqtqjjsagwcbhyzzrnp.supabase.co/storage/v1/object/public/uploads/multi_chart.png" 
         alt="Valuation Methodology Chart" 
         class="content-image">
    <div class="image-caption">Our multi-factor valuation approach</div>
</div>
                
                <div class="methodology-text" id="methodologyText">
                    Loading methodology information...
                </div>
            </div>
        </div>
        
        <!-- Раздел How to Use -->
        <div class="howto-container" id="howtoContainer">
            <button class="back-to-search" id="backToSearchFromHowto">
                <i class="fas fa-arrow-left"></i> Back to Search
            </button>
            
            <div class="howto-content">
                <div class="howto-header">
                    <h2 class="howto-title">How to Use STOXXPOINT</h2>
                    <p class="howto-subtitle">Step-by-step guide to getting the most from our valuation platform</p>
                </div>
                
                <!-- Первая картинка и текст -->
<div class="image-container">
    <img src="https://hfqtqjjsagwcbhyzzrnp.supabase.co/storage/v1/object/public/uploads/points.png" 
         alt="Points Explanation" 
         class="content-image">
    <div class="image-caption">Understanding our 1-9 point valuation system</div>
</div>

                <div class="howto-text" id="pointsText">
                    Loading points explanation...
                </div>
                
                <!-- Вторая картинка и текст -->

<div class="image-container">
    <img src="https://hfqtqjjsagwcbhyzzrnp.supabase.co/storage/v1/object/public/uploads/finviz.png" 
         alt="Finviz Integration" 
         class="content-image">
    <div class="image-caption">Integrating with Finviz for advanced screening</div>
</div>
                <div class="howto-text" id="finvizText">
                    Loading Finviz explanation...
                </div>
            </div>
        </div>
        
        <!-- Ticker Tape -->
        <div class="ticker-container">
            <div class="ticker-tape" id="tickerTape">
                Loading stock data...
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <button class="download-btn" id="downloadBtn">
            <i class="fas fa-download"></i> Download Excel Data 
        </button>
        <div class="copyright">
            © 2025 STOXXPOINT Valuation Platform. All rights reserved.
        </div>
    </footer>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalAuthTitle">Log In to STOXXPOINT</h2>
                <p>Access your personalized stock valuation dashboard</p>
            </div>
            
            <div class="message error-message" id="modalErrorMessage"></div>
            <div class="message success-message" id="modalSuccessMessage"></div>
            
            <!-- Форма входа -->
            <div id="loginForm">
                <div class="input-group">
                    <label for="authEmail">Email Address</label>
                    <input type="email" id="authEmail" placeholder="Enter your email">
                </div>
                
                <div class="input-group">
                    <label for="authPassword">Password</label>
                    <input type="password" id="authPassword" placeholder="Enter your password">
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn cancel-btn" id="cancelBtn">Cancel</button>
                    <button class="modal-btn upload-btn" id="loginBtn">Log In</button>
                </div>
                
                <div class="auth-links">
                    <a href="#" id="switchToRegister">Not registered yet? Join Now</a>
                    <a href="#" id="switchToForgot">Forgot your password? Click Here</a>
                </div>
            </div>
            
            <!-- Форма регистрации -->
            <div id="registerForm" style="display: none;">
                <div class="input-group">
                    <label for="regName">Full Name</label>
                    <input type="text" id="regName" placeholder="Enter your full name">
                </div>
                
                <div class="input-group">
                    <label for="regEmail">Email Address</label>
                    <input type="email" id="regEmail" placeholder="Enter your email">
                </div>
                
                <div class="input-group">
                    <label for="regPassword">Create Password</label>
                    <input type="password" id="regPassword" placeholder="Create a password">
                </div>
                
                <div class="input-group">
                    <label for="regPasswordConfirm">Confirm Password</label>
                    <input type="password" id="regPasswordConfirm" placeholder="Confirm your password">
                </div>
                
                <div class="modal-buttons">
                    <button class="modal-btn cancel-btn" id="cancelRegBtn">Cancel</button>
                    <button class="modal-btn upload-btn" id="registerBtn">Create Account</button>
                </div>
                
                <div class="auth-links">
                    <a href="#" id="switchToLogin">Already have an account? Log In</a>
                </div>
            </div>
            
            <!-- Форма восстановления пароля -->
            <div id="forgotForm" style="display: none;">
                <div class="input-group">
                    <label for="forgotEmail">Email Address</label>
                    <input type="email" id="forgotEmail" placeholder="Enter your email">
                </div>
                
                <p style="color: var(--light-gray); margin-bottom: 20px; text-align: center;">
                    We'll send a password reset link to your email
                </p>
                
                <div class="modal-buttons">
                    <button class="modal-btn cancel-btn" id="cancelForgotBtn">Cancel</button>
                    <button class="modal-btn upload-btn" id="sendResetBtn">Send Reset Link</button>
                </div>
                
                <div class="auth-links">
                    <a href="#" id="switchToLoginFromForgot">Back to Log In</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal" id="adminPanelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Admin Data Panel</h2>
                <p>Upload the latest stock valuation data</p>
            </div>
            
            <div class="input-group">
                <label for="excelFile">Select points.xlsx file</label>
                <input type="file" id="excelFile" accept=".xlsx">
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn" id="cancelAdminBtn">Cancel</button>
                <button class="modal-btn upload-btn" id="uploadBtn">Upload Data</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
   	const stockSearch = document.getElementById('stockSearch');
	const suggestionsContainer = document.getElementById('suggestionsContainer');
        const resultContainer = document.getElementById('resultContainer');
        const methodologyContainer = document.getElementById('methodologyContainer');
        const methodologyText = document.getElementById('methodologyText');
        const methodologyLink = document.getElementById('methodologyLink');
        const backToSearchFromMethodology = document.getElementById('backToSearchFromMethodology');
        const howtoContainer = document.getElementById('howtoContainer'); // Новый контейнер
        const howtoLink = document.getElementById('howtoLink'); // Новая ссылка
        const backToSearchFromHowto = document.getElementById('backToSearchFromHowto'); // Кнопка возврата
        const pointsText = document.getElementById('pointsText'); // Текст для points
        const finvizText = document.getElementById('finvizText'); // Текст для finviz
        const errorMessage = document.getElementById('errorMessage');
        const downloadBtn = document.getElementById('downloadBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const authModal = document.getElementById('authModal');
        const adminPanelModal = document.getElementById('adminPanelModal');
        const lastUpdated = document.getElementById('lastUpdated');
        const backToSearch = document.getElementById('backToSearch');
        const dataStatus = document.getElementById('dataStatus');
        const infoCompany = document.getElementById('infoCompany');
        const infoTicker = document.getElementById('infoTicker');
        const infoPrice = document.getElementById('infoPrice');
        const infoScore = document.getElementById('infoScore');
        const infoLabel = document.getElementById('infoLabel');
        const speedometer = document.getElementById('speedometer');
        const speedometerBackground = document.getElementById('speedometerBackground');
        const gaugeForeground = document.querySelector('.gauge-foreground');
        const mainContent = document.getElementById('mainContent');

        // Auth elements
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const loginBtn = document.getElementById('loginBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const switchToRegister = document.getElementById('switchToRegister');
        const switchToLogin = document.getElementById('switchToLogin');
        const switchToForgot = document.getElementById('switchToForgot');
        const switchToLoginFromForgot = document.getElementById('switchToLoginFromForgot');
        const regName = document.getElementById('regName');
        const regEmail = document.getElementById('regEmail');
        const regPassword = document.getElementById('regPassword');
        const regPasswordConfirm = document.getElementById('regPasswordConfirm');
        const registerBtn = document.getElementById('registerBtn');
        const cancelRegBtn = document.getElementById('cancelRegBtn');
        const forgotEmail = document.getElementById('forgotEmail');
        const sendResetBtn = document.getElementById('sendResetBtn');
        const cancelForgotBtn = document.getElementById('cancelForgotBtn');
        const modalErrorMessage = document.getElementById('modalErrorMessage');
        const modalSuccessMessage = document.getElementById('modalSuccessMessage');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const forgotForm = document.getElementById('forgotForm');
        const modalAuthTitle = document.getElementById('modalAuthTitle');
        const excelFile = document.getElementById('excelFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const cancelAdminBtn = document.getElementById('cancelAdminBtn');
        const tickerTape = document.getElementById('tickerTape');
const SUPABASE_URL = 'https://hfqtqjjsagwcbhyzzrnp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmcXRxampzYWd3Y2JoeXp6cm5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjM1MDY0NjQsImV4cCI6MjAzOTA4MjQ2NH0.0LJ6N2u7eUT0lU6Deez5p6lJ9jNwL7pzN8n7J8lZ7kI';


   // Проверяем, что Supabase доступен глобально
    let supabase;
    if (window.supabase) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } else {
        console.warn('Supabase not available, using fallback');
        // Создаем заглушку для supabase
        supabase = {
            storage: {
                from: () => ({
                    upload: () => Promise.resolve({ error: null, data: {} })
                })
            }
        };
    }

        // Current dataset and user management
        let stockData = [];
        let currentUser = null;
        const users = JSON.parse(localStorage.getItem('stoxxpointUsers') || '[]');
        const adminPass = "admin123"; // Только для демо-версии
        
        // Добавим администратора, если его нет
        if (!users.some(u => u.email === "admin@stoxxpoint.com")) {
            users.push({
                name: "Administrator",
                email: "admin@stoxxpoint.com",
                password: adminPass, // В реальной системе пароль должен храниться в хешированном виде
                role: "admin"
            });
            localStorage.setItem('stoxxpointUsers', JSON.stringify(users));
        }

        // Score labels mapping
        const scoreLabels = {
            1: "EXTREMELY EXPENSIVE",
            2: "VERY EXPENSIVE",
            3: "EXPENSIVE",
            4: "SLIGHTLY EXPENSIVE",
            5: "FAIR PRICE",
            6: "SLIGHTLY CHEAP",
            7: "CHEAP",
            8: "VERY CHEAP",
            9: "EXTREMELY CHEAP"
        };

        // Color mapping for scores
        const scoreColors = {
            1: '#FF4444', 2: '#FF6B44', 3: '#FF8844',
            4: '#FFA544', 5: '#F4AA20',
            6: '#88DD44', 7: '#44CC44', 8: '#44AA44', 9: '#228844'
        };

        // Функция для форматирования даты
        function formatFileDate(dateString) {
            if (!dateString) return "unknown date";
            
            const date = new Date(dateString);
            if (isNaN(date)) return dateString;
            
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }

        // Функция для отображения статуса данных
        function showDataStatus(message, type) {
            dataStatus.textContent = message;
            dataStatus.className = 'data-status';
            dataStatus.style.display = 'block';
            dataStatus.classList.remove('data-loading', 'data-error', 'data-success');
            
            if (type === 'loading') {
                dataStatus.classList.add('data-loading');
            } else if (type === 'error') {
                dataStatus.classList.add('data-error');
            } else if (type === 'success') {
                dataStatus.classList.add('data-success');
                setTimeout(() => {
                    dataStatus.style.display = 'none';
                }, 5000);
            }
        }

        // Обновление UI в зависимости от статуса пользователя
        function updateAuthUI() {
            if (currentUser) {
                if (currentUser.role === "admin") {
                    adminLoginBtn.innerHTML = `<i class="fas fa-user-cog"></i> Admin Panel`;
                } else {
                    adminLoginBtn.innerHTML = `<i class="fas fa-user"></i> ${currentUser.name}`;
                }
            } else {
                adminLoginBtn.innerHTML = "Log In / Sign Up";
            }
        }

        // Initialize ticker tape
        function initTickerTape() {
            if (!stockData.length) {
                tickerTape.innerHTML = "No stock data available";
                return;
            }
            
            tickerTape.innerHTML = '';
            const stocksToShow = stockData.slice(0, Math.min(10, stockData.length));
            
            stocksToShow.forEach(stock => {
                const tickerItem = document.createElement('div');
                tickerItem.className = 'ticker-item';
                const labelColor = scoreColors[stock.score] || '#FFFFFF';
                tickerItem.innerHTML = `
                    <span class="ticker-ticker">${stock.ticker}:</span>
                    <span class="ticker-label" style="color: ${labelColor}">${stock.label}</span>
                `;
                tickerTape.appendChild(tickerItem);
            });
        }

        // Show suggestions with improved search logic
        function showSuggestions(query) {
            suggestionsContainer.innerHTML = '';
            
            if (!query || !stockData.length) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            const normalizedQuery = query.trim().toUpperCase();
            const matchedStocks = stockData.filter(stock => {
                if (normalizedQuery.length <= 4) {
                    return stock.ticker.toUpperCase().includes(normalizedQuery);
                } else {
                    return stock.company.toUpperCase().includes(normalizedQuery);
                }
            });
            
            if (matchedStocks.length > 0) {
                matchedStocks.forEach(stock => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    const labelColor = scoreColors[stock.score] || '#FFFFFF';
                    suggestionItem.innerHTML = `
                        <span class="suggestion-ticker">${stock.ticker}</span>
                        <span class="suggestion-company">${stock.company}</span>
                        <span class="suggestion-label" style="color: ${labelColor}">${stock.label}</span>
                    `;
                    suggestionItem.addEventListener('click', () => {
                        displayStockResult(stock);
                        stockSearch.value = '';
                        suggestionsContainer.style.display = 'none';
                    });
                    suggestionsContainer.appendChild(suggestionItem);
                });
                suggestionsContainer.style.display = 'block';
            } else {
                suggestionsContainer.style.display = 'none';
            }
        }

        // Create background for speedometer (static)
        function createSpeedometerBackground() {
            const ctx = speedometerBackground.getContext('2d');
            
            // Установим размеры canvas
            speedometerBackground.width = speedometerBackground.clientWidth;
            speedometerBackground.height = speedometerBackground.clientHeight;
            
            // Анимация фоновой дуги
            let progress = 0;
            const duration = 800;
            const startTime = Date.now();
            
            function animate() {
                const currentTime = Date.now();
                const elapsed = currentTime - startTime;
                progress = Math.min(elapsed / duration, 1);
                
                // Очищаем canvas
                ctx.clearRect(0, 0, speedometerBackground.width, speedometerBackground.height);
                
                // Рисуем дугу
                const centerX = speedometerBackground.width / 2;
                const centerY = speedometerBackground.height;
                const radius = Math.min(centerX, centerY) * 0.8;
                const startAngle = Math.PI;
                const endAngle = startAngle + (Math.PI * progress);
                
                ctx.beginPath();
                ctx.lineWidth = 20;
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.stroke();
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            animate();
        }

        // Create speedometer chart (foreground)
        function createSpeedometer(score) {
            const ctx = speedometer.getContext('2d');
            
            // Установим размеры canvas
            speedometer.width = speedometer.clientWidth;
            speedometer.height = speedometer.clientHeight;
            
            // Get color for current score
            const color = scoreColors[score] || '#FFFFFF';
            
            // Показываем цветную дугу с анимацией
            setTimeout(() => {
                gaugeForeground.classList.add('visible');
            }, 300);
            
            // Анимация цветной дуги
            let progress = 0;
            const duration = 1000;
            const startTime = Date.now();
            const centerX = speedometer.width / 2;
            const centerY = speedometer.height;
            const radius = Math.min(centerX, centerY) * 0.8;
            const startAngle = Math.PI;
            const maxAngle = startAngle + (Math.PI * (score / 9));
            
            function animate() {
                const currentTime = Date.now();
                const elapsed = currentTime - startTime;
                progress = Math.min(elapsed / duration, 1);
                
                // Очищаем canvas
                ctx.clearRect(0, 0, speedometer.width, speedometer.height);
                
                // Рисуем дугу
                const currentAngle = startAngle + (maxAngle - startAngle) * progress;
                
                ctx.beginPath();
                ctx.lineWidth = 20;
                ctx.strokeStyle = color;
                ctx.arc(centerX, centerY, radius, startAngle, currentAngle);
                ctx.stroke();
                
                // Рисуем текст
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px Arial';
                ctx.fillText(score, centerX, centerY - 20);
                ctx.font = '16px Arial';
                ctx.fillStyle = color;
                ctx.fillText('/9', centerX, centerY + 20);
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            animate();
        }

        // Display stock result
        function displayStockResult(stock) {
            const price = parseFloat(stock.price);
            const score = stock.score;
            
            // Обновляем информационную панель
            infoCompany.textContent = stock.company;
            infoTicker.textContent = stock.ticker;
            infoPrice.textContent = isNaN(price) ? "N/A" : `$${price.toFixed(2)}`;
            infoScore.textContent = `${score}/9`;
            infoLabel.textContent = stock.label;
            
            // Установка цвета для оценки
            const fillColor = scoreColors[score] || '#FFFFFF';
            infoLabel.style.color = fillColor;
            infoLabel.style.backgroundColor = fillColor + '20';
            
            // Показываем результаты с анимацией
            resultContainer.style.display = 'flex';
            setTimeout(() => {
                resultContainer.classList.add('visible');
                
                // Создаем спидометры ПОСЛЕ отображения контейнера
                createSpeedometerBackground();
                createSpeedometer(score);
            }, 10);
            
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }
        }

        // Improved search function
        function searchStock(query) {
            if (!query.trim()) return;
            
            const normalizedQuery = query.trim().toUpperCase();
            let foundStock = null;
            
            if (normalizedQuery.length <= 4) {
                foundStock = stockData.find(stock => 
                    stock.ticker.toUpperCase().includes(normalizedQuery)
                );
            } else {
                foundStock = stockData.find(stock => 
                    stock.company.toUpperCase().includes(normalizedQuery)
                );
            }
            
            if (foundStock) {
                displayStockResult(foundStock);
            } else {
                errorMessage.textContent = `${query} is not supported or not listed in our database`;
                errorMessage.style.display = 'block';
                resultContainer.style.display = 'none';
                
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
        }

        // Download data as Excel
        function downloadData() {
            try {
                if (stockData.length === 0) {
                    alert("No data available to download");
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                const wsData = [
                    ["ticker", "company", "Price", "Score", "Label"],
                    ...stockData.map(stock => [
                        stock.ticker, 
                        stock.company, 
                        stock.price, 
                        stock.score, 
                        stock.label
                    ])
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Stock Ratings");
                XLSX.writeFile(wb, "points.xlsx");
                alert("File downloaded successfully!");
            } catch (error) {
                alert("Error generating Excel file");
                console.error("Download error:", error);
            }
        }

        // Show modal message
        function showModalMessage(message, type) {
            if (type === "error") {
                modalErrorMessage.textContent = message;
                modalErrorMessage.style.display = 'block';
                modalSuccessMessage.style.display = 'none';
            } else {
                modalSuccessMessage.textContent = message;
                modalSuccessMessage.style.display = 'block';
                modalErrorMessage.style.display = 'none';
                setTimeout(() => {
                    modalSuccessMessage.style.display = 'none';
                }, 3000);
            }
        }

        // Process Excel data
        function processExcelData(arrayBuffer) {
            try {
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                
                if (workbook.SheetNames.length === 0) {
                    throw new Error("Excel file has no sheets!");
                }
                
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) {
                    throw new Error("Excel file is empty!");
                }
                
                // Normalize data
                return jsonData.map(item => {
                    const normalizedItem = {};
                    for (const key in item) {
                        normalizedItem[key.toLowerCase().trim()] = item[key];
                    }
                    return normalizedItem;
                });
            } catch (error) {
                console.error("Excel processing error:", error);
                throw error;
            }
        }


// Load initial data from points.xlsx in Supabase Storage
async function loadExcelFile() {
    showDataStatus("Loading stock data from Supabase Storage...", "loading");
    
    try {
        // Используем прямой URL к файлу в Supabase Storage
        const fileUrl = 'https://hfqtqjjsagwcbhyzzrnp.supabase.co/storage/v1/object/public/uploads/points.xlsx';
        const response = await fetch(fileUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const arrayBuffer = await response.arrayBuffer();
        const jsonData = processExcelData(arrayBuffer);
        
        // Получаем дату изменения файла из заголовков
        const lastModified = response.headers.get('last-modified');
        const fileDate = formatFileDate(lastModified);
        
        // Process data
        stockData = jsonData.map(item => {
            // Convert price
            let priceValue = item.price;
            if (typeof priceValue === 'string') {
                priceValue = priceValue.replace(',', '.').replace(/\s/g, '');
            }
            priceValue = parseFloat(priceValue);
            
            // Convert score
            let scoreValue = item.score;
            if (typeof scoreValue === 'string') {
                scoreValue = scoreValue.replace(/\D/g, '');
            }
            scoreValue = parseInt(scoreValue);
            
            return {
                ticker: item.ticker,
                company: item.company,
                price: isNaN(priceValue) ? 0 : priceValue,
                score: isNaN(scoreValue) ? 0 : scoreValue,
                label: item.label
            };
        });
        
        console.log("Successfully loaded stocks:", stockData);
        initTickerTape();
        
        // Обновляем текст с датой последнего обновления
        lastUpdated.textContent = `Latest data calculated after market close on ${fileDate}`;
        showDataStatus("Data loaded successfully!", "success");
        
        // Сохраняем дату для использования при загрузке sample data
        window.fileDate = fileDate;
    } catch (error) {
        const errorMsg = `Error loading data: ${error.message}`;
        showDataStatus(errorMsg, "error");
        lastUpdated.textContent = "Data load failed!";
        console.error(errorMsg, error);
        
        // Load sample data if real data fails
        loadSampleData();
    }
}

        // Load sample data
        function loadSampleData() {
            stockData = [
                {ticker: 'NVDA', company: 'NVIDIA Corporation', price: 157.75, score: 1, label: 'EXTREMELY EXPENSIVE'},
                {ticker: 'MSFT', company: 'Microsoft Corporation', price: 495.94, score: 9, label: 'EXTREMELY CHEAP'},
                {ticker: 'AAPL', company: 'Apple Inc', price: 201.08, score: 2, label: 'VERY EXPENSIVE'},
                {ticker: 'AMZN', company: 'Amazon.com Inc', price: 223.3, score: 1, label: 'EXTREMELY EXPENSIVE'},
                {ticker: 'GOOG', company: 'Alphabet Inc Class C', price: 178.27, score: 2, label: 'VERY EXPENSIVE'},
                {ticker: 'TSLA', company: 'Tesla Inc', price: 186.52, score: 3, label: 'EXPENSIVE'},
                {ticker: 'META', company: 'Meta Platforms Inc', price: 381.23, score: 5, label: 'FAIR PRICE'},
                {ticker: 'BRK.B', company: 'Berkshire Hathaway Inc', price: 412.67, score: 7, label: 'CHEAP'},
                {ticker: 'V', company: 'Visa Inc', price: 263.18, score: 4, label: 'SLIGHTLY EXPENSIVE'},
                {ticker: 'JNJ', company: 'Johnson & Johnson', price: 156.34, score: 8, label: 'VERY CHEAP'}
            ];
            
            initTickerTape();
            
            // Используем сохраненную дату или текущую дату
            const fileDate = window.fileDate || formatFileDate(new Date());
            lastUpdated.textContent = `Sample data loaded (${fileDate})`;
            showDataStatus("Loaded sample data", "success");
        }

    // Process uploaded Excel file and upload to Supabase - исправленная функция
    function processUploadedFile(file) {
        showDataStatus("Processing uploaded file...", "loading");
        
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const jsonData = processExcelData(e.target.result);
                
                // Process data
                stockData = jsonData.map(item => {
                    // Convert price
                    let priceValue = item.price;
                    if (typeof priceValue === 'string') {
                        priceValue = priceValue.replace(',', '.').replace(/\s/g, '');
                    }
                    priceValue = parseFloat(priceValue);
                    
                    // Convert score
                    let scoreValue = item.score;
                    if (typeof scoreValue === 'string') {
                        scoreValue = scoreValue.replace(/\D/g, '');
                    }
                    scoreValue = parseInt(scoreValue);
                    
                    return {
                        ticker: item.ticker,
                        company: item.company,
                        price: isNaN(priceValue) ? 0 : priceValue,
                        score: isNaN(scoreValue) ? 0 : scoreValue,
                        label: item.label
                    };
                });
                
                console.log("Uploaded stocks:", stockData);
                initTickerTape();
                
                // Обновляем дату на текущую
                const fileDate = formatFileDate(new Date());
                lastUpdated.textContent = `Latest data calculated after market close on ${fileDate}`;
                
                // Save to localStorage as backup
                localStorage.setItem('stockData', JSON.stringify(stockData));
                
                // Пытаемся загрузить в Supabase, но не блокируем процесс при ошибке
                try {
                    await uploadToSupabase(file);
                    showDataStatus("Data uploaded successfully!", "success");
                    showModalMessage("Data uploaded successfully!", "success");
                } catch (uploadError) {
                    // Если загрузка в Supabase не удалась, все равно продолжаем
                    showDataStatus("Data processed locally!", "success");
                    showModalMessage("Data processed locally!", "success");
                }
                
                setTimeout(() => {
                    adminPanelModal.style.display = 'none';
                }, 2000);
            } catch (error) {
                const errorMsg = `Error processing file: ${error.message}`;
                showDataStatus(errorMsg, "error");
                showModalMessage(errorMsg, "error");
                console.error("File processing error:", error);
            }
        };
        
        reader.onerror = function() {
            const errorMsg = "Error reading file!";
            showDataStatus(errorMsg, "error");
            showModalMessage(errorMsg, "error");
        };
        
        reader.readAsArrayBuffer(file);
    }

        // Auth functions
        function loginUser(email, password) {
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                updateAuthUI();
                authModal.style.display = 'none';
                showModalMessage("Login successful! Welcome back.", "success");
                return true;
            }
            showModalMessage("Invalid email or password", "error");
            return false;
        }

        function registerUser(name, email, password) {
            // Check if user already exists
            if (users.some(u => u.email === email)) {
                showModalMessage("User with this email already exists", "error");
                return false;
            }
            
            // Simple password validation
            if (password.length < 6) {
                showModalMessage("Password must be at least 6 characters", "error");
                return false;
            }
            
            // Add new user
            const newUser = {
                name: name,
                email: email,
                password: password,
                role: "user"
            };
            
            users.push(newUser);
            localStorage.setItem('stoxxpointUsers', JSON.stringify(users));
            currentUser = newUser;
            updateAuthUI();
            authModal.style.display = 'none';
            showModalMessage("Registration successful! Welcome to STOXXPOINT.", "success");
            return true;
        }

        function sendPasswordReset(email) {
            const user = users.find(u => u.email === email);
            
            if (user) {
                // In a real app, send an email with reset link
                showModalMessage(`Password reset link sent to ${email}`, "success");
                setTimeout(() => {
                    authModal.style.display = 'none';
                }, 3000);
                return true;
            }
            
            showModalMessage("No user found with this email", "error");
            return false;
        }
        
        // Load methodology text from external file
        async function loadMethodologyText() {
            try {
                const response = await fetch('/Methodology.txt');
                
                if (!response.ok) {
                    throw new Error(`Failed to load methodology: ${response.status}`);
                }
                
                const text = await response.text();
                methodologyText.innerHTML = text.replace(/\n/g, '<br>');
            } catch (error) {
                console.error("Error loading methodology:", error);
                methodologyText.innerHTML = `
                    <h3>Comprehensive Valuation Methodology</h3>
                    <p>Our valuation methodology combines multiple quantitative metrics to assess a stock's relative value:</p>
                    <ul>
                        <li><span class="methodology-highlight">Price-to-Earnings (P/E) Ratio</span> - Measures current share price relative to per-share earnings</li>
                        <li><span class="methodology-highlight">Price-to-Book (P/B) Ratio</span> - Compares market value to book value</li>
                        <li><span class="methodology-highlight">Enterprise Value-to-EBITDA</span> - Values a company including debt and excluding cash</li>
                        <li><span class="methodology-highlight">Price-to-Sales (P/S) Ratio</span> - Values a company based on revenue</li>
                        <li><span class="methodology-highlight">Dividend Yield</span> - Measures dividend as percentage of share price</li>
                    </ul>
                    <p>Each metric is weighted according to industry standards and historical performance. Our proprietary algorithm then combines these metrics into a single 1-9 score:</p>
                    <p><strong>1-3:</strong> Overvalued territory - stock price significantly exceeds fundamentals</p>
                    <p><strong>4-6:</strong> Fairly valued - stock price aligns with fundamental value</p>
                    <p><strong>7-9:</strong> Undervalued - stock price below fundamental value</p>
                    <p>This comprehensive approach allows us to provide a holistic view of a stock's valuation relative to its historical norms and industry peers.</p>
                `;
            }
        }
        
        // Загрузка текста для раздела How to Use
async function loadHowtoText() {
    try {
        // Добавляем параметр для обхода кэша
        const cacheBuster = `?t=${new Date().getTime()}`;
        
        // Загрузка первого текста (points.txt)
        const pointsResponse = await fetch(`/points.txt${cacheBuster}`);
        if (!pointsResponse.ok) throw new Error(`Failed to load points text: ${pointsResponse.status}`);
        const pointsTextContent = await pointsResponse.text();
        pointsText.innerHTML = pointsTextContent.replace(/\n/g, '<br>');
        
        // Загрузка второго текста (finviz.txt)
        const finvizResponse = await fetch(`/finviz.txt${cacheBuster}`);
        if (!finvizResponse.ok) throw new Error(`Failed to load finviz text: ${finvizResponse.status}`);
        const finvizTextContent = await finvizResponse.text();
        finvizText.innerHTML = finvizTextContent.replace(/\n/g, '<br>');
    } catch (error) {
        console.error("Error loading howto text:", error);
        // Fallback content
        pointsText.innerHTML = `
            <h3>Understanding the Points System</h3>
            <p>Our 1-9 point valuation system provides a quick assessment of a stock's relative value:</p>
            <ul>
                <li><strong>1-3 points</strong> indicate the stock is overvalued</li>
                <li><strong>4-6 points</strong> indicate fair value</li>
                <li><strong>7-9 points</strong> indicate undervaluation</li>
            </ul>
            <p>This simple scale allows you to quickly identify investment opportunities without complex calculations.</p>
        `;
        
        finvizText.innerHTML = `
            <h3>Integrating with Finviz Screener</h3>
            <p>For advanced screening, you can export our valuation data and import it into Finviz:</p>
            <ol>
                <li>Click the "Download Excel Data" button</li>
                <li>Open the downloaded file in Excel</li>
                <li>Copy the ticker symbols and valuation scores</li>
                <li>Paste into Finviz's custom screener</li>
                <li>Filter by score range to find undervalued opportunities</li>
            </ol>
            <p>This integration allows you to combine our valuation metrics with Finviz's powerful technical and fundamental screening capabilities.</p>
        `;
    }
}
        
        // Show methodology section
        function showMethodology() {
            mainContent.style.display = 'none';
            howtoContainer.style.display = 'none'; // Скрыть раздел How to Use
            methodologyContainer.style.display = 'block';
            setTimeout(() => {
                methodologyContainer.classList.add('visible');
            }, 10);
        }
        
        // Hide methodology section
        function hideMethodology() {
            methodologyContainer.classList.remove('visible');
            setTimeout(() => {
                methodologyContainer.style.display = 'none';
                mainContent.style.display = 'flex';
            }, 500);
        }
        
        // Show How to Use section
        function showHowto() {
            mainContent.style.display = 'none';
            methodologyContainer.style.display = 'none'; // Скрыть раздел методологии
            howtoContainer.style.display = 'block';
            setTimeout(() => {
                howtoContainer.classList.add('visible');
            }, 10);
        }
        
        // Hide How to Use section
        function hideHowto() {
            howtoContainer.classList.remove('visible');
            setTimeout(() => {
                howtoContainer.style.display = 'none';
                mainContent.style.display = 'flex';
            }, 500);
        }

        // Event Listeners
        stockSearch.addEventListener('input', function() {
            showSuggestions(this.value);
        });

        stockSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStock(this.value);
            }
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                suggestionsContainer.style.display = 'none';
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && resultContainer.style.display === 'block') {
                resultContainer.style.display = 'none';
            }
        });

        downloadBtn.addEventListener('click', downloadData);
        
        backToSearch.addEventListener('click', function() {
            resultContainer.classList.remove('visible');
            setTimeout(() => {
                resultContainer.style.display = 'none';
            }, 500);
        });
        
        // Methodology event listeners
        methodologyLink.addEventListener('click', function(e) {
            e.preventDefault();
            showMethodology();
        });
        
        backToSearchFromMethodology.addEventListener('click', function() {
            hideMethodology();
        });
        
        // How to Use event listeners
        howtoLink.addEventListener('click', function(e) {
            e.preventDefault();
            showHowto();
        });
        
        backToSearchFromHowto.addEventListener('click', function() {
            hideHowto();
        });
        
        // Auth event listeners
        adminLoginBtn.addEventListener('click', function() {
            if (currentUser && currentUser.role === "admin") {
                adminPanelModal.style.display = 'flex';
            } else {
                authModal.style.display = 'flex';
                showLoginForm();
            }
        });
        
        cancelBtn.addEventListener('click', function() {
            authModal.style.display = 'none';
        });
        
        cancelAdminBtn.addEventListener('click', function() {
            adminPanelModal.style.display = 'none';
        });
        
        loginBtn.addEventListener('click', function() {
            const email = authEmail.value.trim();
            const password = authPassword.value;
            
            if (!email || !password) {
                showModalMessage("Please fill in all fields", "error");
                return;
            }
            
            loginUser(email, password);
        });
        
        registerBtn.addEventListener('click', function() {
            const name = regName.value.trim();
            const email = regEmail.value.trim();
            const password = regPassword.value;
            const passwordConfirm = regPasswordConfirm.value;
            
            if (!name || !email || !password || !passwordConfirm) {
                showModalMessage("Please fill in all fields", "error");
                return;
            }
            
            if (password !== passwordConfirm) {
                showModalMessage("Passwords do not match", "error");
                return;
            }
            
            registerUser(name, email, password);
        });
        
        sendResetBtn.addEventListener('click', function() {
            const email = forgotEmail.value.trim();
            
            if (!email) {
                showModalMessage("Please enter your email", "error");
                return;
            }
            
            sendPasswordReset(email);
        });
        
        switchToRegister.addEventListener('click', function(e) {
            e.preventDefault();
            showRegisterForm();
        });
        
        switchToLogin.addEventListener('click', function(e) {
            e.preventDefault();
            showLoginForm();
        });
        
        switchToForgot.addEventListener('click', function(e) {
            e.preventDefault();
            showForgotForm();
        });
        
        switchToLoginFromForgot.addEventListener('click', function(e) {
            e.preventDefault();
            showLoginForm();
        });
        
        cancelRegBtn.addEventListener('click', function() {
            authModal.style.display = 'none';
        });
        
        cancelForgotBtn.addEventListener('click', function() {
            authModal.style.display = 'none';
        });
        
        uploadBtn.addEventListener('click', function() {
            const file = excelFile.files[0];
            
            if (!file) {
                showModalMessage("Please select a file to upload", "error");
                return;
            }
            
            if (!file.name.endsWith('.xlsx')) {
                showModalMessage("Please upload an Excel file (.xlsx)", "error");
                return;
            }
            
            processUploadedFile(file);
        });
        
        window.addEventListener('click', function(e) {
            if (e.target === authModal) {
                authModal.style.display = 'none';
            }
            if (e.target === adminPanelModal) {
                adminPanelModal.style.display = 'none';
            }
        });

        // Auth form functions
        function showLoginForm() {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            forgotForm.style.display = 'none';
            modalAuthTitle.textContent = "Log In to STOXXPOINT";
        }
        
        function showRegisterForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            forgotForm.style.display = 'none';
            modalAuthTitle.textContent = "Create Your Account";
        }
        
        function showForgotForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'none';
            forgotForm.style.display = 'block';
            modalAuthTitle.textContent = "Reset Your Password";
        }

        // Initialize the page
function init() {
    // Load data
    loadExcelFile();
    updateAuthUI();
    loadMethodologyText();
    loadHowtoText(); // Загрузка текста для раздела How to Use
    
    // Проверка загрузки изображений с задержкой
    setTimeout(() => {
        checkImageLoading();
        debugImageLoading(); // Добавляем отладку
    }, 2000);
}

function checkImageLoading() {
    const images = document.querySelectorAll('.content-image');
    console.log(`Found ${images.length} images to check`);
    
    images.forEach((img, index) => {
        console.log(`Image ${index + 1}: ${img.src}`);
        
        if (img.complete) {
            if (img.naturalHeight === 0) {
                console.error(`Image failed to load: ${img.src}`);
                handleImageError(img);
            } else {
                console.log(`Image already loaded: ${img.src}`);
            }
        } else {
            img.onload = function() {
                console.log(`✓ Image loaded successfully: ${img.src}`);
            };
            img.onerror = function() {
                console.error(`✗ Failed to load image: ${img.src}`);
                handleImageError(img);
            };
        }
    });
}

function handleImageError(img) {
    img.style.display = 'none';
    const caption = img.nextElementSibling;
    if (caption && caption.classList.contains('image-caption')) {
        caption.textContent = 'Image not available: ' + img.alt;
        caption.style.color = 'var(--orange)';
        caption.style.fontWeight = 'bold';
    }
}

    // Upload file to Supabase Storage - ОДНА функция вместо двух одинаковых
    async function uploadToSupabase(file) {
        try {
            console.log("Starting upload to Supabase...");
            
            // Проверяем, доступен ли Supabase
            if (!window.supabase) {
                throw new Error('Supabase library not loaded');
            }
            
            // Создаем клиент
            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // Upload file to Supabase Storage
            const { data, error } = await supabaseClient.storage
                .from('uploads')
                .upload('points.xlsx', file, {
                    cacheControl: '3600',
                    upsert: true
                });
            
            if (error) {
                console.error('Supabase upload error:', error);
                throw new Error(`Upload failed: ${error.message}`);
            }
            
            console.log("File uploaded to Supabase successfully:", data);
            return true;
        } catch (error) {
            console.error("Supabase upload error:", error);
            // Не прерываем выполнение, просто логируем ошибку
            showDataStatus("Data processed locally, but cloud upload failed", "error");
            return false; // Возвращаем false, но не прерываем процесс
        }
    }

// Функция для проверки загрузки изображений
function debugImageLoading() {
    console.log('Checking image URLs...');
    
    const imageUrls = [
        'https://hfqtqjjsagwcbhyzzrnp.supabase.co/storage/v1/object/public/uploads/multi_chart.png',
        'https://hfqtqjjsagwcbhyzzrnp.supabase.co/storage/v1/object/public/uploads/points.png',
        'https://hfqtqjjsagwcbhyzzrnp.supabase.co/storage/v1/object/public/uploads/finviz.png'
    ];
    
    imageUrls.forEach(url => {
        fetch(url)
            .then(response => {
                console.log(`✓ ${url}: ${response.status} ${response.statusText}`);
            })
            .catch(error => {
                console.error(`✗ ${url}: ${error.message}`);
            });
    });
}

// Вызовите эту функцию после init()
setTimeout(debugImageLoading, 2000);


        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>